API Testing
===========

Tavern_ is used to test the API. Tests are defined
within yaml files inside the tests directory.

To run a test, navigate to the tests directory and execute::

    pipenv run py.test test_helloworld.tavern.yaml

.. _Tavern: https://taverntesting.github.io/

Most tests require environment variables,
such as BASE_URL. These are defined
in a .env file in the root of this project.

The script tests/conftest.py contains pytest fixtures that
extract and return environment variables from this file. The
fixtures are callable from the yaml test scripts.

Testing User Endpoints in the Consumer API
-------------------------------------------

The User endpoints require an access token
that is generated when a user signs in
with Auth0.

To obtain this access token, a simple UI
has been added to the consumer API. It is accessible
from https://plotsensor.com/api/consumer/v1/accesstoken

Press the Authorize button to be redirected to the Auth0
authorize page. Login using a social provider and be redirected
back to the /callback page with an authorization code.
The callback handler exchanges this for an access token,
which is displayed to the user.

The access token can then be used to create a new user
at the consumer/v1/user endpoint (to be written) and otherwise
interact with the consumer API.

The access token can be decoded and it contains both the
api identifier in a claim and the oauth_id of the user.
The oauth_id can be used to request an id_token from Auth0
and populate user information in the DB.

It can also be verified as being signed by Auth0
(not generated by some bad actor) by obtaining the
JSON Web Key set from https://YOUR_AUTH0_DOMAIN/.well-known/jwks.json