test_name: Create a box, add a capture to it then delete the box.

marks:
  - usefixtures:
      - baseurl
      - clientid
      - clientsecret
      - user_fixture
      - token_fixture

# Include variables
includes:
  - !include includes.yaml

stages:
  - name: Obtain a token

    # Define the request to be made
    request:
      url: "{baseurl}/api/admin/v1/token"
      method: POST
      json:
        client_id: "{clientid}"
        client_secret: "{clientsecret}"
      headers:
        content-type: application/json

    # and the expected response code and body
    response:
      status_code: 200
      save:
        body:
          admin_token: token

  - name: Use the token to create a new box

    # Define the request to be made
    request:
      url: "{baseurl}/api/admin/v1/boxes"
      method: POST
      headers:
        content-type: application/json
        Authorization: "bearer {admin_token:s}"

    # and the expected response code and body
    response:
      status_code: 200
      body:
        timeregistered: !anything
        id: !anyint
        secretkey: !anystr
        serial: !anystr
      save:
        $ext:
          function: utils:create_capture_for_box
        body:
          test_box_id: id



  - name: Create a capture and add it to the box with the serial

    # Define the request to be made
    request:
      url: "{baseurl}/api/consumer/v1/me/captures"
      method: POST
      json:
        serial: "{serial}"
        statusb64: "{statusb64}"
        timeintb64: "{timeintb64}"
        circbufb64: "{circbufb64}"
        ver: "{ver}"
      headers:
        content-type: application/json
        Authorization: "bearer {token_fixture:s}"

    # and the expected response body
    response:
      status_code: 200
      body:
        batvoltagemv: !anyfloat
        boxserial: !anystr
        cursorpos: !anyint
        id: !anyint
        loopcount: !anyint
        md5: !anystr
        status:
          brownout: !anybool
          parent_capture: !anyint
          clockfail: !anybool
          id: !anyint
          lpm5wakeup: !anybool
          misc: !anybool
          resetsalltime: !anyint
          supervisor: !anybool
          watchdog: !anybool
        timeintmins: !anyint
        timestamp: !anystr
        version: !anyint
      save:
        body:
          test_capture_id: id

  - name: GET this list of captures for this box and verify that it contains the one we just created.

    # Define the request to be made
    request:
      url: "{baseurl}/api/consumer/v1/me/captures"
      method: GET
      headers:
        content-type: application/json
        Authorization: "bearer {token_fixture:s}"

    # and the expected response body
    response:
      status_code: 200
      body:
        - batvoltagemv: !anyfloat
          boxserial: !anystr
          cursorpos: !anyint
          id: !int "{test_capture_id:d}"
          loopcount: !anyint
          md5: !anystr
          status:
            brownout: !anybool
            parent_capture: !anyint
            clockfail: !anybool
            id: !anyint
            lpm5wakeup: !anybool
            misc: !anybool
            resetsalltime: !anyint
            supervisor: !anybool
            watchdog: !anybool
          timeintmins: !anyint
          timestamp: !anystr
          version: !anyint


  - name: GET the capture for this box and verify that it contains the correct fields

    # Define the request to be made
    request:
      url: "{baseurl}/api/consumer/v1/capture/{test_capture_id}"
      method: GET
      headers:
        content-type: application/json

    # and the expected response body
    response:
      status_code: 200
      body:
        batvoltagemv: !anyfloat
        boxserial: !anystr
        cursorpos: !anyint
        id: !int "{test_capture_id:d}"
        loopcount: !anyint
        md5: !anystr
        status:
          brownout: !anybool
          parent_capture: !anyint
          clockfail: !anybool
          id: !anyint
          lpm5wakeup: !anybool
          misc: !anybool
          resetsalltime: !anyint
          supervisor: !anybool
          watchdog: !anybool
        timeintmins: !anyint
        timestamp: !anystr
        version: !anyint

  - name: Delete the box by ID.

    # Define the request to be made
    request:
      url: "{baseurl}/api/admin/v1/box/{test_box_id}"
      method: DELETE
      headers:
        content-type: application/json
        Authorization: "bearer {admin_token:s}"

    # and the expected response body
    response:
      status_code: 204